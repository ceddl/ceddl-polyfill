(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.ceddl=factory())})(this,function(){"use strict";var _values={};var _events;var logger=new Logger;var eventbus=new Eventbus;function Eventbus(){}Eventbus.prototype.prepareEvent=function(name){if(!_events)_events={};if(!_events[name])_events[name]=[];return _events[name]};Eventbus.prototype.off=function(name,callback,scope){var events=this.prepareEvent(name);if(callback){for(var i=events.length-1;i>=0;i--){var existingCb=events[i].callback;var existingScope=events[i].scope;if(callback===existingCb&&scope===existingScope){events.splice(i,1)}}}else{delete _events[name]}};Eventbus.prototype.on=function(name,callback,scope){if(_values[name]){try{callback.apply(scope||this,_values[name])}catch(error){logger.error(error.message)}}this.prepareEvent(name).push({callback:callback,scope:scope})};Eventbus.prototype.once=function(name,callback,scope){if(_values[name]){try{callback.apply(scope||this,_values[name])}catch(error){logger.error(error.message)}}else{this.prepareEvent(name).push({callback:callback,scope:scope,once:true})}};Eventbus.prototype.emit=function(name){var events=this.prepareEvent(name).slice();var args;for(var j=1,lengthj=arguments.length;j<lengthj;j++){if(!args){args=[]}args.push(arguments[j])}_values[name]=args;for(var i=0,lengthi=events.length;i<lengthi;i++){var callback=events[i].callback;var scope=events[i].scope||this;try{callback.apply(scope,args)}catch(error){logger.error(error.message)}if(events[i].once){this.off(name,callback,events[i].scope)}}};Eventbus.prototype.clearHistory=function(){Object.keys(_values).forEach(function(key){delete _values[key]})};function logAndEmit(level,message){if(!message||message===""){return}message="ceddl:"+level+" "+message;if(console&&console.log){switch(level){case"info":console.info?console.info(message):console.log(message);break;case"warn":console.warn?console.warn(message):console.log(message);break;case"field":console.warn?console.warn(message):console.log(message);break;case"error":console.error?console.error(message):console.log(message);break;default:console.log(message)}}eventbus.emit("ceddl:"+level,{exDescription:message,exFatal:level==="error"})}function Logger(){this.fieldErrors=[]}Logger.prototype.log=function(message){logAndEmit("log",message)};Logger.prototype.info=function(message){logAndEmit("info",message)};Logger.prototype.field=function(message){if(this.fieldErrors.includes(message)){return}this.fieldErrors.push(message);logAndEmit("warn",message)};Logger.prototype.warn=function(message){logAndEmit("warn",message)};Logger.prototype.error=function(message){logAndEmit("error",message)};var assign;if(typeof Object.assign=="function"){assign=Object.assign}else{assign=function(target){if(target===undefined||target===null){throw new TypeError("Cannot convert first argument to object")}var to=Object(target);for(var i=1;i<arguments.length;i++){var nextSource=arguments[i];if(nextSource===undefined||nextSource===null){continue}var keysArray=Object.keys(Object(nextSource));for(var nextIndex=0,len=keysArray.length;nextIndex<len;nextIndex++){var nextKey=keysArray[nextIndex];var desc=Object.getOwnPropertyDescriptor(nextSource,nextKey);if(desc!==undefined&&desc.enumerable){to[nextKey]=nextSource[nextKey]}}}return to}}function Model(args){this._args=args;this.fields={}}Model.prototype.setField=function(key,fieldObj){this.fields[key]=fieldObj};Model.prototype.getValue=function(){var validation=this.validate();if(validation.valid){var data={};for(var key in this.fields){var field=this.fields[key];var value=field.getValue();if(value!==null&&value!==undefined){data[key]=value}}return data}else{return{error:"Cant get values from an invalid Model"}}};Model.prototype.validate=function(){var errors=[];for(var key in this.fields){var field=this.fields[key];var fieldErrors=field.getErrors();if(fieldErrors){errors.push({field:key,msg:fieldErrors})}}return{valid:errors.length<=0,errors:errors}};function Field(key,value,required){if((value===undefined||value===null||value.length<=0)&&required){this.error="Required field "+key+" not set"}this.key=key;this.value=value}Field.isFlat=function(){return true};Field.isList=function(){return false};Field.prototype.getValue=function(){return this.value};Field.prototype.getErrors=function(){return this.error};function StringField(key,value,required,pattern){Field.call(this,key,value,required);this._patternReg=new RegExp(pattern);if(value!==null&&value!==undefined&&typeof value!=="string"){this.error="Invalid value for StringField "+key+": "+value}if(value==="undefined"){this.error="Invalid value for StringField "+key+": "+value}if(value&&pattern&&!this._patternReg.test(value)){this.error="Invalid value for StringField "+key+", should be "+pattern}}StringField.isFlat=function(){return true};StringField.isList=function(){return false};StringField.prototype=Object.create(Field.prototype);StringField.prototype.constructor=StringField;function BooleanField(key,value,required){Field.call(this,key,value,required);var _trueStrings=["true","TRUE","True"];var _falseStrings=["false","FALSE","False"];var _allowedStrings=[].concat(_trueStrings,_falseStrings);if(value!==undefined&&value!==null&&(typeof value==="boolean"||_allowedStrings.indexOf(value)>-1)){if(typeof value==="string"){if(_trueStrings.indexOf(value)>-1){this.value=true}else{this.value=false}}else{this.value=value}}else{if(value!==undefined&&value!==null&&typeof value!=="boolean"){this.error="Invalid value for BooleanField "+key+": "+value}}}BooleanField.isFlat=function(){return true};BooleanField.isList=function(){return false};BooleanField.prototype=Object.create(Field.prototype);BooleanField.prototype.constructor=BooleanField;function ModelField(model,key,value,required){Field.call(this,key,value,required);if(value){try{this._object=new model(value)}catch(e){this.error=model+" is not a valid Model"}}else{this._object=null}}ModelField.isFlat=function(){return false};ModelField.isList=function(){return false};ModelField.prototype=Object.create(Field.prototype);ModelField.prototype.constructor=ModelField;ModelField.prototype.getValue=function(){return this._object?this._object.getValue():{}};ModelField.prototype.getErrors=function(){var errors=[];if(this.error){errors.push({field:this.key,msg:this.error})}if(this._object){var validator=this._object.validate();for(var i=0;i<validator.errors.length;i++){errors.push(validator.errors[i])}}return errors.length>0&&errors||null};function ListField(model,key,list,required,pattern,ModelFactory){Field.call(this,key,list,required);this._items=[];var item;if(list){for(var i=0;i<list.length;i++){item=list[i];try{if(item._model){this._items.push(new ModelFactory.models[item._model](item))}else{this._items.push(new model(item))}}catch(e){if(item._model){this.error=item._model+" is not a valid Model"}else{this.error=model+" is not a valid Model"}}}}}ListField.isFlat=function(){return false};ListField.isList=function(){return true};ListField.prototype=Object.create(Field.prototype);ListField.prototype.constructor=ListField;ListField.prototype.getValue=function(){var data=[];var item;for(var i=0;i<this._items.length;i++){item=this._items[i];data.push(item.getValue())}return data};ListField.prototype.getErrors=function(){var errors=[];var item,validator;if(this.error){errors.push({field:this.key,msg:this.error})}for(var i=0;i<this._items.length;i++){item=this._items[i];validator=item.validate();for(var j=0;j<validator.errors.length;j++){errors.push(validator.errors[j])}}return errors.length>0&&errors||null};function NumberField(key,value,required){Field.call(this,key,value,required);if(value){this.value=parseFloat(value);if(isNaN(this.value)){this.error="Invalid value for NumberField "+key+":"+value}}}NumberField.isFlat=function(){return true};NumberField.isList=function(){return false};NumberField.prototype=Object.create(Field.prototype);NumberField.prototype.constructor=NumberField;function ArrayField(field,key,list,required){Field.call(this,key,list,required);this._items=[];var item;if(list){for(var i in list){item=list[i];try{this._items.push(new field(key+i,item,true))}catch(e){this.error=field+" is not a valid field"}}}}ArrayField.isFlat=function(){return true};ArrayField.isList=function(){return false};ArrayField.prototype=Object.create(Field.prototype);ArrayField.prototype.constructor=ArrayField;ArrayField.prototype.getErrors=function(){var errors=[];var item,error;if(this.error){errors.push({field:this.key,msg:this.error})}for(var i=0;i<this._items.length;i++){item=this._items[i];error=item.getErrors();if(error){errors.push({field:item.key,msg:error})}}return errors.length>0&&errors||null};function ModelFactoryClass(){this.models={}}Object.defineProperty(ModelFactoryClass.prototype,"fields",{get:function fields(){return{StringField:StringField,BooleanField:BooleanField,ModelField:ModelField,ListField:ListField,NumberField:NumberField,ArrayField:ArrayField}}});ModelFactoryClass.prototype.create=function(modelArgs){var mf=this;var model=function(values){var myModel;if(modelArgs.extends){myModel=new mf.models[modelArgs.extends](values)}else{myModel=new Model(values);myModel.fields={}}for(var key in modelArgs.fields){var field=modelArgs.fields[key];if(field.type){if(field.type===ModelField||field.type===ListField){var foreignModel=mf.models[field.foreignModel];if(foreignModel){myModel.fields[key]=new field.type(foreignModel,key,values[key],field.required,field.pattern,mf)}else{logger.warn("foreignModel on "+modelArgs.key+" is not defined")}}else if(field.type===ArrayField){myModel.fields[key]=new field.type(field.fieldType,key,values[key],field.required,field.pattern)}else{myModel.fields[key]=new field.type(key,values[key],field.required,field.pattern)}}else{logger.warn(field.type+" is not a valid field type.")}}return myModel};model.getFields=function(){var fields={};if(modelArgs.extends){fields=new mf.models[modelArgs.extends].getFields}assign(fields,modelArgs.fields);return fields};model.isRoot=function(){return modelArgs.root?modelArgs.root:false};mf.models[modelArgs.key]=model;return model};var ModelFactory=new ModelFactoryClass;var isDate=function(d){return d instanceof Date};var isEmpty=function(o){return Object.keys(o).length===0};var isObject=function(o){return o!=null&&o instanceof Object};var properObject=function(o){if(this.isObject(o)&&!o.hasOwnProperty){return Object.assign({},o)}else{return o}};var toCamelCase=function(attrString){return attrString.replace(/-([a-z])/g,function(g){return g[1].toUpperCase()})};var isArrayOfStrings=function(o){if(toString.call(o)!="[object Array]"){return false}for(var i=0;i<o.length;i++){if(typeof o[i]!=="string")return false}return true};var simpleDeepClone=function(target){var that=this;var isArray=Array.isArray(target);var isObject=!isArray&&this.isObject(target);if(isArray){return target.map(this.simpleDeepClone.bind(this))}else if(isObject){return Object.keys(target).reduce(function(acc,key){acc[key]=that.simpleDeepClone(target[key]);return acc},{})}else{return target}};var diff=function(lhs,rhs){var that=this;var tmp1,tmp2,tmp3;if(lhs===rhs){return{}}if(!this.isObject(lhs)||!this.isObject(rhs)){return rhs}var l=this.properObject(lhs);var r=this.properObject(rhs);var deletedValues=Object.keys(l).reduce(function(acc,key){if(r.hasOwnProperty(key)){return acc}else{tmp1={};tmp1[key]=undefined;return assign(acc,tmp1)}},{});if(this.isDate(l)||this.isDate(r)){if(l.valueOf()==r.valueOf()){return{}}return r}return Object.keys(r).reduce(function(acc,key){if(!l.hasOwnProperty(key)){tmp2={};tmp2[key]=r[key];return assign(acc,tmp2)}var difference=that.diff(l[key],r[key]);if(that.isObject(difference)&&that.isEmpty(difference)&&!that.isDate(difference)){return acc}tmp3={};tmp3[key]=difference;return assign(acc,tmp3)},deletedValues)};var pageReady=function(callback){var isReady;if(document.attachEvent){isReady=document.readyState==="complete"}else{isReady=document.readyState!=="loading"}if(isReady){callback()}else{document.addEventListener("DOMContentLoaded",callback)}};var getAllElementsAttributes=function(element,opt){var obj={};if(element){obj=this.simpleDeepClone(element.dataset)}if(!opt||opt.excludeCEDDLAttributes!==true){obj.ceddl={}}if(element){for(var i=0;i<element.attributes.length;i++){var attrib=element.attributes[i];var name=attrib.name;if(obj.ceddl&&name.indexOf("ceddl-")>-1){obj.ceddl[this.toCamelCase(name.replace("ceddl-",""))]=attrib.value}}}return obj};var perfXtagString=function(element){var paths=[];var index=0;var hasindex=false;for(;element&&element.nodeType==1;element=element.parentNode){index=0;hasindex=false;if(element.previousSibling){for(var sibling=element.previousSibling;sibling;sibling=sibling.previousSibling){if(sibling.nodeType==10){continue}if(sibling.nodeName==element.nodeName){hasindex=true;++index}}}if(element.nextElementSibling&&element.nextElementSibling.nodeName==element.nodeName){hasindex=true}var tagName=element.nodeName.toLowerCase();var pathIndex;if(element.id&&element.id!==""){pathIndex='/*[@id="'+element.id+'"]';paths.splice(0,0,pathIndex);break}else{pathIndex=hasindex?"["+(index+1)+"]":"";paths.splice(0,0,tagName+pathIndex)}}return paths.length?"/"+paths.join("/"):null};var debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;if(null==wait)wait=100;function later(){var last=Date.now()-timestamp;if(last<wait&&last>=0){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);context=args=null}}}var debounced=function(){context=this;args=arguments;timestamp=Date.now();var callNow=immediate&&!timeout;if(!timeout)timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args);context=args=null}return result};return debounced};var utils={isDate:isDate,isEmpty:isEmpty,isObject:isObject,properObject:properObject,toCamelCase:toCamelCase,isArrayOfStrings:isArrayOfStrings,simpleDeepClone:simpleDeepClone,diff:diff,pageReady:pageReady,getAllElementsAttributes:getAllElementsAttributes,perfXtagString:perfXtagString,debounce:debounce};function emitPropertyEvents(eventName,diff,baseKey,store){if(store&&store[baseKey]!==undefined&&store[baseKey]!==null){eventbus.emit(eventName,store[baseKey])}else{eventbus.emit(eventName,undefined)}if(Array.isArray(diff)){diff.forEach(function(item,index){emitPropertyEvents(eventName+"."+index,item,index,store[baseKey])})}else if(diff===Object(diff)){Object.keys(diff).forEach(function(key){var child=diff[key];emitPropertyEvents(eventName+"."+key,child,key,store[baseKey])})}}function ModelStore(){this._modelStore={}}ModelStore.prototype.getStoredModels=function(debug){if(debug&debug===true){return this._modelStore}return utils.simpleDeepClone(this._modelStore)};ModelStore.prototype.storeModel=function(key,data){var existingModel=this._modelStore[key]||{};var newData=data||{};var diff=utils.diff(existingModel,newData);if(data){this._modelStore[key]=data}else{delete this._modelStore[key]}if(!utils.isEmpty(diff)){eventbus.emit("ceddl:models",this.getStoredModels());emitPropertyEvents(key,diff,key,this.getStoredModels())}};ModelStore.prototype.clearStore=function(){var that=this;Object.keys(this._modelStore).forEach(function(key){delete that._modelStore[key]})};function EventStore(){this._eventStore=[]}EventStore.prototype.getStoredEvents=function(debug){if(debug&debug===true){return this._eventStore}return this._eventStore.map(function(value){return{name:value.name,data:value.data}})};EventStore.prototype.storeEvent=function(name,data){this._eventStore.push({name:name,data:data});eventbus.emit("ceddl:events",this._eventStore);eventbus.emit(name,data)};EventStore.prototype.clearStore=function(){this._eventStore.splice(0,this._eventStore.length)};function isClickTarget(element){return element.hasAttribute("ceddl-click")||element.nodeType===1&&element.tagName.toUpperCase()==="BUTTON"||element.nodeType===1&&element.tagName.toUpperCase()==="A"}function delegate(callback,el){var currentElement=el;do{if(!isClickTarget(currentElement))continue;callback(currentElement);return}while(currentElement.nodeName.toUpperCase()!=="BODY"&&(currentElement=currentElement.parentNode))}function getClickEventData(element){var textContent=element.textContent.replace(/\s\s+/g," ").trim();var baseObj={xtag:utils.perfXtagString(element),action:"click",tag:element.tagName.toLowerCase(),url:window.location.href,textContent:textContent.length<75?textContent:undefined};if(element.id&&element.id!==""){baseObj.id=element.id}if(element.href&&element.href!==""){baseObj.href=element.href}assign(baseObj,utils.getAllElementsAttributes(element));delete baseObj.ceddl;return baseObj}function getsubmitEventData(element){var baseObj={xtag:utils.perfXtagString(element),action:"submit",tag:element.tagName.toLowerCase(),url:window.location.href};if(element.id&&element.id!==""){baseObj.id=element.id}if(element.action&&element.action!==""){baseObj.href=element.action}assign(baseObj,utils.getAllElementsAttributes(element));delete baseObj.ceddl;return baseObj}function ClickObserver(ceddl){this.ceddl=ceddl;this.measureClick=this.measureClick.bind(this);this.measureSubmit=this.measureSubmit.bind(this);utils.pageReady(this.setListeners.bind(this))}ClickObserver.prototype.measureClick=function(element){var attributes=utils.getAllElementsAttributes(element);var eventName=attributes.ceddl.click||"click";var eventData=getClickEventData(element);this.ceddl.emitEvent(eventName,eventData)};ClickObserver.prototype.measureSubmit=function(element){var attributes=utils.getAllElementsAttributes(element);var eventName=attributes.ceddl.submit||"submit";var eventData=getsubmitEventData(element);this.ceddl.emitEvent(eventName,eventData)};ClickObserver.prototype.setListeners=function(){var that=this;var doc=document.body||document.documentElement;doc.addEventListener("click",function(e){e=e||event;var target=e.target;delegate(that.measureClick,target)},true);doc.addEventListener("submit",function(e){e=e||event;var target=e.target;that.measureSubmit(target)},true)};function CeddlObserver(ceddl,modelFactory){var that=this;this.ceddl=ceddl;this.modelFactory=modelFactory;this.debouncedGenerateModelObjectsCall=utils.debounce(function(){that.generateModelObjects()},100);utils.pageReady(function(){that.init()})}CeddlObserver.prototype.getElementAttributes=function(modelName,el){var fields=this.modelFactory.models[modelName].getFields();var elAttr=utils.getAllElementsAttributes(el);var object={};var item;if(el===null){return undefined}if(elAttr.ceddl.model){object["model"]=elAttr.ceddl.model}for(var key in fields){var field=fields[key];if(field.type.isFlat()){if(elAttr[key]){object[key]=elAttr[key]}}else if(field.type.isList()){var elements=el.querySelectorAll("[ceddl-observe="+field.foreignModel+"]");object[key]=[];for(var i=0;i<elements.length;i++){item=elements[i];var model=item.getAttribute("ceddl-model");object[key].push(this.getElementAttributes(model||field.foreignModel,item))}}else{var element=el.querySelector("[ceddl-observe="+key+"]");if(element){object[key]=this.getElementAttributes(field.foreignModel,element)}}}return object};CeddlObserver.prototype.generateModelObjects=function(){var rootModels=[];var dataObj;var that=this;for(var model in this.modelFactory.models){if(this.modelFactory.models[model].isRoot()){rootModels.push(model)}}rootModels.forEach(function(modelName){dataObj=that.getElementAttributes(modelName,document.querySelector('[ceddl-observe="'+modelName+'"]'));that.ceddl.emitModel(modelName,dataObj)})};CeddlObserver.prototype.setListeners=function(){var ceddlObserver=new MutationObserver(this.debouncedGenerateModelObjectsCall);var config={attributes:true,childList:true,subtree:true,characterData:false};ceddlObserver.observe(document.body,config)};CeddlObserver.prototype.init=function(){this.setListeners();this.generateModelObjects()};var _modelStore,_eventStore,_clickObserver,_CeddlObserver;function _printFieldErrors(key,errors){var error;for(var i=0;i<errors.length;i++){error=errors[i];if(Array.isArray(error.msg)){_printFieldErrors(key+"."+error.field,error.msg)}else{var message=key+"."+error.field+": "+error.msg;logger.field(message)}}}function Base(){_modelStore=new ModelStore;_eventStore=new EventStore}Base.prototype.initialize=function(){if(!_clickObserver&&!_CeddlObserver){_clickObserver=new ClickObserver(this);_CeddlObserver=new CeddlObserver(this,ModelFactory)}else{_modelStore.clearStore();_eventStore.clearStore();eventbus.clearHistory();_CeddlObserver.generateModelObjects();eventbus.emit("initialize")}};Base.prototype.emitEvent=function(name,data){_eventStore.storeEvent(name,data)};Base.prototype.emitModel=function(name,data){var model=ModelFactory.models[name];if(!model){logger.field("Model does not exist for key: "+name);return}if(data===undefined){_modelStore.storeModel(name,data);return}var object=new ModelFactory.models[name](data);var validator=object.validate();if(validator.valid){_modelStore.storeModel(name,object.getValue())}else{_printFieldErrors(name,validator.errors)}};Base.prototype.getModels=function(){return _modelStore.getStoredModels()};Base.prototype.getEvents=function(){return _eventStore.getStoredEvents()};Object.defineProperty(Base.prototype,"modelFactory",{get:function modelFactory(){return ModelFactory}});Object.defineProperty(Base.prototype,"eventbus",{get:function eventbus(){return eventbus}});var index=new Base;return index});